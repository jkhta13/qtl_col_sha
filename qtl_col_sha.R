#Load qtl package for QTL mapping and snow package for multicore processing
library(qtl)
library(snow)
require(snow)

#Set working directory with data
setwd("/Users/jkta/Desktop/data/")

#Data checking------------------------------------------------------------------

#Reads QTL data
col_sha <- read.cross(format = "csv", file = "col_sha_qtl_final2.csv",
                      genotypes = c("AA", "BB"))
class(col_sha)[1] <- "riself"

#Plot colxsha data to make sure there are no wonky phenotypes
summary(col_sha)
plot(col_sha)

#Estimates recombination frations between chromosomes to see if there are no linked
#markers between different chromosomes
col_sha <- est.rf(col_sha)
plot.rf(col_sha)

#Estimates a genetic map using MLE
newmap <- est.map(col_sha, verbose = TRUE, error.prob = 0.001)
plot.map(col_sha, newmap)
replace.map(col_sha, newmap)
plot.map(col_sha)

#Calculates error LODs with specific markers, to make sure there are no 
#genotyping errors
col_sha <- calc.errorlod(col_sha, error.prob = 0.001)
top.errorlod(col_sha, cutoff = 3)

#Interval mapping---------------------------------------------------------------

#Simulates genotypes between markers, and calculates their genotype 
#probabilities for use in interval mapping
col_sha <- sim.geno(col_sha, n.draws = 64, step = 1, error.prob = 0.001)
col_sha <- calc.genoprob(col_sha, step = 1, error.prob = 0.001)

h2_out_imp <- scanone(col_sha, method = "imp", pheno.col = 3)

#Permutes the data to derive LOD scores; this is done by "freezing" the 
#genotypes and randomly assigning phenotypes. Threshold for background noise.
h2_out_imp <- scanone(col_sha, method = "imp", pheno.col = 3)
h2_perm_imp <- scanone(col_sha, method = "imp", pheno.col = 3, n.perm = 2000, 
                       verbose = TRUE, n.cluster = 4)

#Assign the 5% significance threshold so that we can visually inspect the LOD 
#score cutoff.
summary(h2_perm_imp)
h2_perm95 <- summary(h2_perm_imp)[1]

#Plotting the single-QTL analysis with LOD threshold; evidence of QTLs on 
#Chr 1, 4, and 5 (possibly 2 on 5)
plot(h2_out_imp, ylab = "LOD Score")
abline(h = h2_perm95, lty = 2)
summary(h2_out_imp, perms = h2_perm_imp, alpha = 0.05, pvalues = TRUE)

#Building QTL model for Height 2------------------------------------------------

#Building a single QTL model by adding highest LOD marker on Chr 5
h2_col_sha_qtl <- makeqtl(col_sha, chr = 5, pos = 12, what = "draws")
summary(h2_col_sha_qtl)

#Checking for other significant QTLs
h2_col_sha_aq <- addqtl(col_sha, qtl = h2_col_sha_qtl, method = "imp", 
                        pheno.col = 3)

#Statistically checks for other QTLs based on our permutation data; additional
#QTLs on Chr 1, 4 and another on 5
summary(h2_col_sha_aq, perms = h2_perm_imp, alpha = 0.05, pvalues = TRUE)
plot(h2_col_sha_aq, ylab = "LOD Score")


#Adding additional QTLs to our model with other putative QTL positions
h2_col_sha_qtl1 <- makeqtl(cross = col_sha, chr = c(1, 4, 5, 5), 
                           pos = c(37.7, 80.7, 12, 79.6))

#Refines the location of our QTLs using MLE
h2_col_sha_rq <- refineqtl(col_sha, qtl = h2_col_sha_qtl1, method = "imp", 
                           pheno.col = 3)

h2_col_sha_fq <- fitqtl(col_sha, qtl = h2_col_sha_qtl1, pheno.col = 3, 
                        method = "imp", formula = y ~ Q1 + Q2 + Q3 + Q4)

summary(h2_col_sha_fq)

#Checks for any interactions between QTLs in our 4 QTL model
addint(col_sha, qtl = h2_col_sha_qtl1, method = "imp", 
       pheno.col = 3)

#2D scan for QTLs; pairwise comparison for each interval location between 
#chromosomes
h2_s2_col_sha <- scantwo(col_sha, pheno.col = 3, method = "imp", 
                         verbose = TRUE, n.cluster = 4)
h2_s2_col_sha_perm <- scantwo(col_sha, pheno.col = 3, method = "imp", 
                              n.perm = 1000, n.cluster = 8)

#Generates thresholds for our 2D scan
summary(h2_s2_col_sha_perm)

#Determines putative QTLs and their locations based on our thresholds
summary(h2_s2_col_sha, perms = h2_s2_col_sha_perm, 
        thresholds = c(5.54, 4.1, 3.45, 4.43, 2.48))
summary(h2_col_sha_rq)

#Confirms our QTL model based on our single-QTL analysis
#QTLs on Chr 1, 4, and 5
plot(h2_s2_col_sha, main = "2D QTL Scan")
plot(h2_col_sha_rq)

#Finding markers based on the positions of significant QTLs in 2D scan
h2_Q2_Q3 <- find.marker(col_sha, chr = c(4, 5), pos = c(62, 13))

#Phenotype and effect plots between markers; all paired markers seem additive
#except for significant markers on Chr 4 and 5
par(mfrow = c(1, 2))
plot.pxg(col_sha, marker = h2_Q2_Q3, pheno.col = 3)
effectplot(col_sha, mname1 = h2_Q2_Q3[1], mname2 = h2_Q2_Q3[2], pheno.col = 3, 
           add.legend = FALSE)

#Comparing putative QTLs between our single-QTL analysis and 2D scan
summary(h2_out_imp, perms = h2_perm_imp, alpha = 0.05, pvalues = TRUE)
summary(h2_s2_col_sha, perms = h2_s2_col_sha_perm, pvalues = TRUE, 
        thresholds = c(5.54, 4.1, 3.45, 4.43, 2.48))

#QTL model based on our 2D results
h2_s2_col_sha_qtl <- makeqtl(col_sha, chr = c(1, 4, 5, 5), 
                             pos = c(40, 81, 12, 80))
plot(h2_s2_col_sha_qtl)
h2_s2_col_sha_fq <- fitqtl(col_sha, qtl = h2_s2_col_sha_qtl, pheno.col = 3, 
                           formula = y ~ Q1 + Q2 * Q3 + Q4, method = "imp")

#QTLs seem significant except for the interaction between Chr 4 and 5
summary(h2_s2_col_sha_fq)

#Refine positions of our 2D QTL model
h2_s2_col_sha_rq <- refineqtl(col_sha, qtl = h2_s2_col_sha_qtl, pheno.col = 3,
                              method = "imp", formula = y ~ Q1 + Q2 * Q3 + Q4)
summary(h2_s2_col_sha_rq)

#Fit QTL model with our new positions; all QTLs are still significant, but the
#interaction between Chr 4 and 5 (between pos 12.2 and 12.6, respectively) are
#now significant
h2_s2_col_sha_fq1 <- fitqtl(col_sha, qtl = h2_s2_col_sha_rq, pheno.col = 3,
                            method = "imp", formula = y ~ Q1 + Q2 * Q3 + Q4)
summary(h2_s2_col_sha_fq1)

#Checks to see if there are additional QTLs that could be added to our model 
#based on a single-QTL scan
h2_s2_col_sha_aq <- addqtl(col_sha, qtl = h2_s2_col_sha_rq, pheno.col = 3, 
                           method = "imp", 
                           formula = y ~ Q1 + Q2 * Q3 + Q4)

#Additional putative QTLs on Chr 2 and 4; their LOD > 2
plot(h2_s2_col_sha_aq, ylab = "LOD Score")
summary(h2_s2_col_sha_aq)

#Extended QTL model on Height 2 (LOD scores only ~ 2)---------------------------
h2_s2_col_sha_qtl1 <- makeqtl(col_sha, chr = c(1, 2, 4, 4, 5, 5), 
                              pos = c(37.7, 36, 12.3, 80.7, 12, 77.3))
plot(h2_s2_col_sha_qtl1)

h2_s2_col_sha_fq2 <- fitqtl(col_sha, qtl = h2_s2_col_sha_qtl1, pheno.col = 3, 
                            formula = y ~ Q1 + Q2 + Q3 * Q5 + Q4 + Q6, 
                            method = "imp")

#All QTLs seem significant
summary(h2_s2_col_sha_fq2)

#Refining our new expanded model
h2_s2_col_sha_rq1 <- refineqtl(col_sha, qtl = h2_s2_col_sha_qtl1, 
                               pheno.col = 3, method = "imp", 
                               formula = y ~ Q1 + Q2 + Q3 * Q5 + Q4 + Q6)
summary(h2_s2_col_sha_rq1)

#Refined QTL model LOD increased by 0.32
h2_s2_col_sha_fq3 <- fitqtl(col_sha, qtl = h2_s2_col_sha_rq1, pheno.col = 3, 
                            formula = y ~ Q1 + Q2 + Q3 * Q5 + Q4 + Q6, 
                            method = "imp")

#Comparison of 4 QTL model vs 6 QTL model; 22 vs 30 LOD, and 54% vs 65% variance
#explained
summary(h2_s2_col_sha_fq3)
summary(h2_s2_col_sha_fq1)

#Possible interaction between both QTLs on Chr 5
addint(col_sha, qtl = h2_s2_col_sha_rq1, 
       formula = y ~ Q1 + Q2 + Q3 * Q5 + Q4 + Q6, 
       pheno.col = 3, method = "imp")

#Checking for additional QTLs; no significant QTLs
h2_s2_col_sha_aq1 <- addqtl(col_sha, qtl = h2_s2_col_sha_rq1, pheno.col = 3, 
                            method = "imp", 
                            formula = y ~ Q1 + Q2 + Q3 * Q5 + Q4 + Q6)
plot(h2_s2_col_sha_aq1, ylab = "LOD Score")
summary(h2_s2_col_sha_aq1)

#MQM model on Height 2----------------------------------------------------------

#Augments the data (basically imputes the data), by adding additional invidiuals
aug_col_sha <- mqmaugment(col_sha, minprob =  0.925, verbose = TRUE)
geno.image(aug_col_sha)

#Comparison of single-QTL analysis scan (on original data) and mqmscan on 
#augmented data
one_mqm_col_sha <- scanone(col_sha, pheno.col = 3, method = "imp")
scan_mqm_col_sha <- mqmscan(aug_col_sha, pheno.col = 3, n.clusters = 4)
plot(one_mqm_col_sha, scan_mqm_col_sha, col = c("red", "blue"), lty = 1:2)
abline(h = h2_perm95, lty = 2)
summary(scan_mqm_col_sha)

#Finding markers that have significant LOD scores in the mqmscan, and then 
#setting them as cofactors to find additional QTLs
h2_mqm_markers <- find.marker(aug_col_sha, chr = c(1, 4, 5), pos = c(40, 80, 10))
h2_mqm_mts <- find.markerindex(aug_col_sha, name = h2_mqm_markers)
h2_mqm_cofactors <- mqmsetcofactors(aug_col_sha, cofactors = h2_mqm_mts)
h2_mqm_col_sha_co1 <- mqmscan(aug_col_sha, cofactors = h2_mqm_cofactors, 
                              pheno.col = 3, n.cluster = 4)
plot(h2_mqm_col_sha_co1)
summary(h2_mqm_col_sha_co1)

#Doing backwards method of finding QTLs-----------------------------------------

#Setting automatic cofactors (50 of them)
auto_col_sha <- mqmautocofactors(aug_col_sha, 50)
h2_auto_mqm_col_sha <- mqmscan(aug_col_sha, auto_col_sha, pheno.col = 3, 
                               n.cluster = 4)

#Setting every 5th marker as a cofactor and then analyzing for QTLs
set_col_sha <- mqmsetcofactors(aug_col_sha, 5)
h2_set_mqm_col_sha <- mqmscan(aug_col_sha, set_col_sha, pheno.col = 3, 
                              n.cluster = 4)
summary(h2_auto_mqm_col_sha)
summary(h2_set_mqm_col_sha)

plot(h2_auto_mqm_col_sha, h2_set_mqm_col_sha, h2_out_imp, 
     col = c("blue", "green", "red"), lty = 1:3)

#Checking putative QTL locations in mqm backwards models and forward selection 
#QTL model
par(mfrow = c(2, 2))
plot(mqmgetmodel(h2_auto_mqm_col_sha))
plot(mqmgetmodel(h2_set_mqm_col_sha))
plot(h2_s2_col_sha_rq1)

#Setting permutations to find QTL significance thresholds
mqm.perm <- mqmpermutation(aug_col_sha, scanfunction = mqmscan, 
                           cofactors = h2_mqm_cofactors, pheno.col = 3, 
                           batchsize = 25, n.perm = 2000)
mqm.perm.process <- mqmprocesspermutation(mqm.perm)
summary(mqm.perm.process)
mqmplot.permutations(mqm.perm, legend = FALSE)


#Building a QTL model for bolt days---------------------------------------------

#Starting out with an imputation model
out.impbd <- scanone(col_sha, method = "imp", pheno.col = 5, n.cluster = 4)
perm.impbd <- scanone(col_sha, method = "imp", pheno.col = 5, n.perm = 2000, 
                      verbose = TRUE, n.cluster = 4)
summary(perm.impbd)
permbd <- summary(perm.impbd)[1]

#Seems like there are QTLs on Chr 1, 4, and 5 (possibly 2 on Chr 5)
plot(out.impbd, ylab = "LOD score")
abline(h = permbd, lty = 2)

#Again this verifies the location of QTLs on Chr 1, 4, and 5
summary(out.impbd, perms = perm.impbd, alpha = 0.05)

#Building a QTL model using the significant QTL's from out single-QTL analysis
bd_col_sha_qtl <- makeqtl(col_sha, chr = c(1, 4, 5), pos = c(66.02, 6.34, 12))
plot(bd_col_sha_qtl)

#Fitting our QTL model; all putative QTLs are significant
bd_col_sha_fq <- fitqtl(col_sha, pheno.col = 5, qtl = bd_col_sha_qtl, 
                        method = "imp", formula = y ~ Q1 + Q2 + Q3)
summary(bd_col_sha_fq)

bd_col_sha_rq <- refineqtl(col_sha, qtl = bd_col_sha_qtl, pheno.col = 5,
                                method = "imp", formula = y ~ Q1 + Q2 + Q3)

#QTL 1 moved a bit
plot(bd_col_sha_qtl)
plot(bd_col_sha_rq)

bd_col_sha_fq1 <- fitqtl(col_sha, pheno.col = 5, qtl = bd_qtl_col_sha_rq, 
                        method = "imp", formula = y ~ Q1 + Q2 + Q3)
summary(bd_col_sha_fq1)

#Checking for interactions between QTLs in our model; seems like QTL1 (Chr 1) 
#and QTL2 (Chr 4) interact, as well as QTL2 (Chr 4) with QTL3 (Chr 5)
addint(col_sha, qtl = bd_qtl_col_sha_rq, pheno.col = 5, method = "imp",
       formula = y ~ Q1 + Q2 + Q3)

#Adding interactions to our model, all QTLs and their interactions are 
#significant
bd_col_sha_fq2 <- fitqtl(col_sha, pheno.col = 5, qtl = bd_qtl_col_sha_rq, 
                         method = "imp", formula = y ~ Q1 * Q2 + Q2 * Q3)
summary(bd_col_sha_fq2)

#Checking for additional QTLs
bd_col_sha_aq <- addqtl(col_sha, qtl = bd_qtl_col_sha_rq, pheno.col = 5, 
                        method = "imp", formula = y ~ Q1 * Q2 + Q2 * Q3)

#Seems like there are additional QTLs on Chr 1, 4, and 5
summary(bd_col_sha_aq)

#Making another model with additional 3 QTLs
bd_col_sha_qtl1 <- makeqtl(col_sha, chr = c(1, 1, 3, 4, 5, 5), 
                           pos = c(39.7, 76.2, 4, 4, 13, 70))
plot(bd_col_sha_qtl1)

#Seems like all the QTLs and the interactions seem significant
bd_col_sha_fq3 <- fitqtl(col_sha, pheno.col = 5, qtl = bd_col_sha_qtl1, 
                         method = "imp", 
                         formula = y ~ Q1 * Q4 + Q2 + Q3 + Q4 * Q5 + Q6)
summary(bd_col_sha_fq3)

#Refining the QTL locations of our new model
bd_col_sha_rq1 <- refineqtl(col_sha, qtl = bd_col_sha_qtl1, pheno.col = 5,
                            method = "imp", 
                            formula = y ~ Q1 * Q4 + Q2 + Q3 + Q4 * Q5 + Q6)
plot(bd_col_sha_rq1)

#Checking for interactions in our 6 QTL model; interactions between Chr 1 and 3,
#Chr 1 and 5, Chr 4 with Chr 1, and Chr 4 with Chr 5
addint(col_sha, qtl = bd_col_sha_rq1, pheno.col = 5, method = "imp",
       formula = y ~ Q1 * Q4 + Q2 + Q3 + Q4 * Q5 + Q6)

#Adding the interactions and checking for the fit of the model; everything is 
#significant again
bd_col_sha_fq4 <- fitqtl(col_sha, pheno.col = 5, qtl = bd_col_sha_rq1, 
                         method = "imp", 
                         formula = y ~ Q1 * Q4 + Q2 + Q3 + Q4 * Q5 + 
                                       Q6 + Q2 * Q4 + Q6 * Q4)
summary(bd_col_sha_fq4)

#Refining our model
bd_col_sha_rq2 <- refineqtl(col_sha, qtl = bd_col_sha_rq1, pheno.col = 5, 
                            method = "imp", 
                            formula = y ~ Q1 * Q4 + Q2 + Q3 + Q4 * Q5 + 
                                          Q6 + Q2 * Q4 + Q6 * Q4)
plot(bd_col_sha_rq2)

#Checking for additional QTLs; additional QTLs on Chr 1 and 5, but the one on 
#Chr 5 pos 20.5 might be an artifact because it is close to QTL 4 
bd_col_sha_aq1 <- addqtl(col_sha, qtl = bd_col_sha_rq2, pheno.col = 5, 
                         method = "imp", 
                         formula = y ~ Q1 * Q4 + Q2 + Q3 + Q4 * Q5 + 
                                       Q6 + Q2 * Q4 + Q6 * Q4)
summary(bd_col_sha_aq1)

summary(bd_col_sha_rq2)

#Additional putative QTLs
bd_col_sha_qtl2 <- makeqtl(col_sha, chr = c(1, 1, 3, 4, 5, 5),
                           pos = c(39.7, 78, 17, 4, 10.6, 70))
par(mfrow = c(1, 2))
plot(bd_col_sha_rq2)
plot(bd_col_sha_qtl2)
bd_col_sha_fq4 <- fitqtl(col_sha, pheno.col = 5, qtl = bd_col_sha_qtl2, 
                         method = "imp", 
                         formula = y ~ Q1 * Q4 + Q2 + Q3 + Q4 * Q5 + Q6 + 
                                   Q2 * Q4 + Q4 * Q6)
summary(bd_col_sha_fq4)
bd_col_sha_rq3 <- refineqtl(col_sha, pheno.col = 5, qtl = bd_col_sha_qtl2, 
                            method = "imp", 
                            formula = y ~ Q1 * Q4 + Q2 + Q3 + Q4 * Q5 + Q6 + 
                                      Q2 * Q4 + Q4 * Q6)
plot(bd_col_sha_rq3)

bd_col_sha_aq2 <- addqtl(col_sha, qtl = bd_col_sha_qtl2, pheno.col = 5, 
                         method = "imp", 
                         formula = y ~ Q1 * Q4 + Q2 + Q3 + Q4 * Q5 + Q6 + 
                                   Q2 * Q4 + Q4 * Q6)
summary(bd_col_sha_aq2)
addint(col_sha, qtl = bd_col_sha_qtl2, pheno.col = 5, method = "imp",
       formula = y ~ Q1 * Q4 + Q2 + Q3 + Q4 * Q5 + Q6 + Q2 * Q4 + Q4 * Q6)
plot(bd_col_sha_qtl2)

bd_col_sha_fq5 <- fitqtl(col_sha, pheno.col = 5, qtl = bd_col_sha_qtl2, 
                         method = "imp", 
                         formula = y ~ Q1 * Q3 + Q1 * Q4 + Q1 * Q6 + Q2 + Q3 + 
                                   Q4 * Q5 + Q6 + Q2 * Q4 + Q4 * Q6)
summary(bd_col_sha_fq5)

#Building our QTL model based on a 2D scan
scantwo_bd_col_sha <- scantwo(col_sha, pheno.col = 5, method = "imp", 
                              verbose = TRUE, n.cluster = 12)

scantwo_bd_col_sha_perm <- scantwo(col_sha, pheno.col = 5, method = "imp",
                                   n.perm = 5000, n.cluster = 12)

#MQM model of bolt days QTL--------------------------------------------------
aug_col_sha <- mqmaugment(col_sha, minprob =  0.925, verbose = TRUE)
geno.image(aug_col_sha)

#Comparison of single-QTL analysis scan (on original data) and mqmscan on 
#augmented data
one_bd_mqm_col_sha <- scanone(col_sha, pheno.col = 5, method = "imp")
scan_bd_mqm_col_sha <- mqmscan(aug_col_sha, pheno.col = 5, n.clusters = 4)
plot(one_bd_mqm_col_sha, scan_bd_mqm_col_sha, col = c("red", "blue"), lty = 1:2)
abline(h = perm95)
summary(scan_bd_mqm_col_sha)

#Finding markers that have significant LOD scores in the mqmscan, and then 
#setting them as cofactors to find additional QTLs
markers_bd_mqm <- find.marker(aug_col_sha, chr = c(1, 4, 5), pos = c(65, 5, 10))
mqm_bd_mts <- find.markerindex(aug_col_sha, name = markers_bd_mqm)
mqm_bd_cofactors <- mqmsetcofactors(aug_col_sha, cofactors = mqm_bd_mts)
co1_bd_mqm_col_sha <- mqmscan(aug_col_sha, cofactors = mqm_bd_cofactors, 
                              pheno.col = 5, n.cluster = 4)
plot(co1_bd_mqm_col_sha)
summary(co1_bd_mqm_col_sha)

#Doing backwards method of finding QTLs-----------------------------------------

#Setting automatic cofactors (50 of them)
auto_bd_col_sha <- mqmautocofactors(aug_col_sha, 50)
auto_bd_mqm_col_sha <- mqmscan(aug_col_sha, auto_bd_col_sha, pheno.col = 5, 
                               n.cluster = 4)

#Setting every 5th marker as a cofactor and then analyzing for QTLs
set_bd_col_sha <- mqmsetcofactors(aug_col_sha, 5)
set_bd_mqm_col_sha <- mqmscan(aug_col_sha, set_bd_col_sha, pheno.col = 5, 
                              n.cluster = 4)
summary(auto_bd_mqm_col_sha)
summary(set_bd_mqm_col_sha)
summary(co1_bd_mqm_col_sha)

par(mfrow = c(2, 1))
plot(auto_bd_mqm_col_sha, set_bd_mqm_col_sha, co1_bd_mqm_col_sha, 
     col = c("blue", "green", "red"), lty = 1:3)

#Checking putative QTL locations in mqm backwards models and forward selection 
#QTL model
par(mfrow = c(2, 2))
plot(mqmgetmodel(auto_bd_mqm_col_sha))
plot(mqmgetmodel(set_bd_mqm_col_sha))
plot(bd_col_sha_qtl2)
summary(set_bd_mqm_col_sha)

#It seems like choosing the starting qtl map is arbitrary because the methods
#produce similar maps; using setcofactors seem to add extraneous QTLs
bd_mqm_col_sha_qtl <- makeqtl(col_sha, chr = c(1, 2, 3, 4, 5), 
                              pos = c(75, 5, 15, 5, 10))
plot(bd_mqm_col_sha_qtl)
bd_mqm_col_sha_fq <- fitqtl(col_sha, pheno.col = 5, qtl = bd_mqm_col_sha_qtl, 
                            method = "imp", 
                            formula = y ~ Q1 + Q2 + Q3 + Q4 + Q5)
summary(bd_mqm_col_sha_fq)
addint(col_sha, pheno.col = 5, qtl = bd_mqm_col_sha_qtl, 
       method = "imp", formula = y ~ Q1 + Q2 + Q3 + Q4 + Q5)
bd_mqm_col_sha_fq1 <- fitqtl(col_sha, pheno.col = 5, qtl = bd_mqm_col_sha_qtl,
                             method = "imp", 
                             formula = y ~ Q1 + Q2 * Q3 + Q4 * Q5)
summary(bd_mqm_col_sha_fq1)
bd_mqm_col_sha_rq <- refineqtl(col_sha, pheno.col = 5, qtl = bd_mqm_col_sha_qtl,
                               method = "imp",
                               formula = y ~ Q1 + Q2 * Q3 + Q4 * Q5)
plot(bd_mqm_col_sha_rq)
bd_mqm_col_sha_fq2 <- fitqtl(col_sha, pheno.col = 5, qtl = bd_mqm_col_sha_rq,
                             method = "imp",
                             formula = y ~ Q1 + Q2 * Q3 + Q4 * Q5)
summary(bd_mqm_col_sha_fq2)

bd_mqm_col_sha_aq <- addqtl(col_sha, pheno.col = 5, qtl = bd_mqm_col_sha_rq, 
                            method = "imp", 
                            formula = y ~ Q1 + Q2 * Q3 + Q4 * Q5)
summary(bd_mqm_col_sha_aq)
plot(bd_mqm_col_sha_aq)

par(mfrow = c(1, 2))
plot(bd_col_sha_qtl2)
summary(bd_col_sha_qtl2)
summary(bd_mqm_col_sha_rq)
plot(bd_mqm_col_sha_rq)

#Adding QTL on Chr 2 on model made from single-QTL analysis
bd_mqm_col_sha_qtl2 <- makeqtl(col_sha, chr = c(1, 1, 2, 3, 4, 5, 5), 
                               pos = c(39.7, 78, 3.9, 17, 4, 10.6, 70))
plot(bd_mqm_col_sha_qtl2)
bd_mqm_col_sha_fq3 <- fitqtl(col_sha, pheno.col = 5, qtl = bd_mqm_col_sha_qtl2, 
                             method = "imp", 
                             formula = y ~ Q1 * Q4 + Q1 * Q5 + Q1 * Q7 + Q2 * 
                                       Q5 + Q3 * Q4 + Q5 * Q6 + Q5 * Q7)

#When I added the QTL on Chr 2 (with no interaction with Chr 3), there was no 
#significance, but when I added the interaction, the QTL/interaction are 
#significant
summary(bd_mqm_col_sha_fq3)

#Refining the locations of putative QTLs in our new model
bd_mqm_col_sha_rq2 <- refineqtl(col_sha, pheno.col = 5, 
                                qtl = bd_mqm_col_sha_qtl2, 
                                method = "imp", 
                                formula = y ~ Q1 * Q4 + Q1 * Q5 + Q1 * Q7 + Q2 * 
                                Q5 + Q3 * Q4 + Q5 * Q6 + Q5 * Q7)

#Checking out new model; everything seems significant
bd_mqm_col_sha_fq4 <- fitqtl(col_sha, pheno.col = 5, qtl = bd_mqm_col_sha_rq2, 
                             method = "imp", 
                             formula = y ~ Q1 * Q4 + Q1 * Q5 + Q1 * Q7 + Q2 * 
                             Q5 + Q3 * Q4 + Q5 * Q6 + Q5 * Q7)
summary(bd_mqm_col_sha_fq4)

#Checking for additional interactions between our QTLs; nothing seems 
#significant
addint(col_sha, pheno.col = 5, qtl = bd_mqm_col_sha_rq2, method = "imp",
       formula = y ~ Q1 * Q4 + Q1 * Q5 + Q1 * Q7 + Q2 * 
                 Q5 + Q3 * Q4 + Q5 * Q6 + Q5 * Q7)

#Checking for additional QTLs, again nothing seems significant
bd_mqm_col_sha_aq2 <- addqtl(col_sha, pheno.col = 5, qtl = bd_mqm_col_sha_rq2, 
                             method = "imp",
                             formula = y ~ Q1 * Q4 + Q1 * Q5 + Q1 * Q7 + Q2 * 
                                       Q5 + Q3 * Q4 + Q5 * Q6 + Q5 * Q7)


plot(bd_mqm_col_sha_rq2)
summary(bd_mqm_col_sha_rq2)
summary(bd_mqm_col_sha_aq2)
summary(bd_mqm_col_sha_fq4)
summary(bd_col_sha_fq5)

#Building a QTL model based on 2D scan of bolt days-----------------------------
scantwo_bd_col_sha <- scantwo(col_sha, pheno.col = 5, method = "imp")
scantwo_bd_col_sha_perm <- scantwo(col_sha, pheno.col = 5, method = "imp",
                                   n.perm = 5000)
summary(scantwo_bd_col_sha_perm)

#Seems like there are only significant QTLs on Chr 4 and 5
summary(scantwo_bd_col_sha, perms = scantwo_bd_col_sha_perm, 
        thresholds = c(6.59, 5.38, 3.84, 4.69, 3.36))
plot(scantwo_bd_col_sha)
bd_s2_col_sha_qtl <- makeqtl(col_sha, chr = c(4, 5), pos = c(3, 15))
bd_s2_col_sha_fq <- fitqtl(col_sha, pheno.col = 5, qtl = bd_s2_col_sha_qtl, 
                           method = "imp", formula = y ~ Q1 * Q2)
summary(bd_s2_col_sha_fq)
bd_s2_col_sha_rq <- refineqtl(col_sha, pheno.col = 5, qtl = bd_s2_col_sha_qtl, 
                              method = "imp", formula = y ~ Q1 * Q2)
bd_s2_col_sha_aq <- addqtl(col_sha, pheno.col = 5, qtl = bd_s2_col_sha_qtl,
                           method = "imp", formula = y ~ Q1 * Q2)
summary(bd_s2_col_sha_aq)

bd_s2_col_sha_qtl2 <- makeqtl(col_sha, chr = c(1, 4, 5), pos = c(57, 3, 15))
bd_s2_col_sha_fq <- fitqtl(col_sha, pheno.col = 5, qtl = bd_s2_col_sha_qtl)
#Bolt days effect plots---------------------------------------------------------
plot(bd_mqm_col_sha_rq2)
summary(bd_mqm_col_sha_fq4)

bd_Q1_Q4 <- find.marker(col_sha, chr = c(1, 3), pos = c(39.7, 10.8))
bd_Q1_Q5 <- find.marker(col_sha, chr = c(1, 4), pos = c(39.7, 69.6))
bd_Q1_Q7 <- find.marker(col_sha, chr = c(1, 5), pos = c(39.7, 69.6))
bd_Q2_Q5 <- find.marker(col_sha, chr = c(1, 4), pos = c(78.4, 3.9))
bd_Q3_Q4 <- find.marker(col_sha, chr = c(2, 3), pos = c(11.4, 10.8))
bd_Q5_Q6 <- find.marker(col_sha, chr = c(4, 5), pos = c(3.9, 11))
bd_Q5_Q7 <- find.marker(col_sha, chr = c(4, 5), pos = c(3.9, 69.6))

par(mfrow = c(1, 2))
plot.pxg(col_sha, marker = bd_Q1_Q4, pheno.col = 5)
effectplot(col_sha, mname1 = bd_Q1_Q4[1], mname2 = bd_Q1_Q4[2], pheno.col = 5, 
           add.legend = FALSE)
plot.pxg(col_sha, marker = bd_Q1_Q5, pheno.col = 5)
effectplot(col_sha, mname1 = bd_Q1_Q5[1], mname2 = bd_Q1_Q5[2], pheno.col = 5, 
           add.legend = FALSE)
plot.pxg(col_sha, marker = bd_Q1_Q7, pheno.col = 5)
effectplot(col_sha, mname1 = bd_Q1_Q7[1], mname2 = bd_Q1_Q7[2], pheno.col = 5, 
           add.legend = FALSE)
plot.pxg(col_sha, marker = bd_Q2_Q5, pheno.col = 5)
effectplot(col_sha, mname1 = bd_Q2_Q5[1], mname2 = bd_Q2_Q5[2], pheno.col = 5, 
           add.legend = FALSE)
plot.pxg(col_sha, marker = bd_Q3_Q4, pheno.col = 5)
effectplot(col_sha, mname1 = bd_Q3_Q4[1], mname2 = bd_Q3_Q4[2], pheno.col = 5, 
           add.legend = FALSE)
plot.pxg(col_sha, marker = bd_Q5_Q6, pheno.col = 5)
effectplot(col_sha, mname1 = bd_Q5_Q6[1], mname2 = bd_Q5_Q6[2], pheno.col = 5, 
           add.legend = FALSE)
plot.pxg(col_sha, marker = bd_Q5_Q7, pheno.col = 5)
effectplot(col_sha, mname1 = bd_Q5_Q7[1], mname2 = bd_Q5_Q7[2], pheno.col = 5, 
           add.legend = FALSE)

#Height 1 QTL analysis----------------------------------------------------------
col_sha <- sim.geno(col_sha, n.draws = 128, step = 0.1, error.prob = 0.001)
col_sha <- calc.genoprob(col_sha, step = 0.1, error.prob = 0.001)
h1_out.imp <- scanone(col_sha, pheno.col = 2, method = "imp")
h1_out.perm <- scanone(col_sha, pheno.col = 2, method = "imp", n.perm = 2000, 
                       n.cluster = 4)
